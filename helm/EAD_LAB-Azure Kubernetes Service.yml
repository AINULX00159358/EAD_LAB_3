name: $(date:yyyyMMdd)$(rev:.r)
resources:
  repositories:
  - repository: self
    type: git
    ref: refs/heads/HelmJob
jobs:
- job: Job_1
  displayName: 'Agent job for EAD Lab3'
  pool:
    vmImage: ubuntu-latest
  steps:
  - checkout: self
    clean: true
    fetchTags: false
  - task: KubectlInstaller@0
    displayName: Install Kubectl 1.26.3
    inputs:
      kubectlVersion: 1.26.3
  - task: HelmInstaller@0
    displayName: 'Install Helm 3.9.3'
    inputs:
      helmVersion: 3.9.3
      kubectlVersion: 1.26.3
  - task: CmdLine@2
    displayName: 'running helm dependency build'
    inputs:
      script: >-
        pwd

        cd helm/eadlab3

        helm dependency build
  - task: HelmDeploy@0
    displayName: 'Deploy MySql, Secrets and Service using helm'
    inputs:
      connectionType: Kubernetes Service Connection
      kubernetesServiceEndpoint: 52e7b636-9ce7-4f7d-be99-3bb1c59c1584
      namespace: default
      command: 'upgrade '
      chartType: FilePath
      chartPath: helm/eadlab3
      releaseName: ead-lab3-mysql
      upgradetiller: false
      save: false
      install: false
      arguments: --install
  - task: KubernetesManifest@0
    displayName: 'Deploy job to create database and table'
    inputs:
      kubernetesServiceConnection: 52e7b636-9ce7-4f7d-be99-3bb1c59c1584
      namespace: default
      manifests: helm/eadlab3/mysql-db-job.yaml
  - task: Kubernetes@1
    displayName: 'review database and table created'
    inputs:
      kubernetesServiceEndpoint: 52e7b636-9ce7-4f7d-be99-3bb1c59c1584
      namespace: default
      command: exec
      arguments: -it deployment/ead-lab3-mysql -- mysql -h ead-lab3-mysql -pteaseadlab3 -e "show databases; use my_test_db; select * from Person"
...
